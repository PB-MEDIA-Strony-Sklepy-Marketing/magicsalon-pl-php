name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  php-lint:
    name: PHP Lint
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, json, fileinfo

    - name: Lint PHP files
      run: find dist -name "*.php" -exec php -l {} \;

  phpstan:
    name: PHPStan Analysis
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, json, fileinfo
        tools: composer

    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: Run PHPStan
      run: ./vendor/bin/phpstan analyse dist

  php-cs-fixer:
    name: PHP CS Fixer
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, json, fileinfo
        tools: composer, php-cs-fixer

    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: Run PHP CS Fixer
      run: ./vendor/bin/php-cs-fixer fix --dry-run --diff --verbose

  security-check:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Check for sensitive files
      run: |
        if find . -name ".env" -o -name "*.key" -o -name "*.pem" | grep -q .; then
          echo "âŒ Sensitive files found in repository!"
          exit 1
        else
          echo "âœ… No sensitive files found"
        fi

    - name: Check for hardcoded credentials
      run: |
        if grep -r -i -E "(password|passwd|pwd|api_key|apikey|secret|token)\s*=\s*['\"][^'\"]+['\"]" dist --exclude-dir=plugins --exclude-dir=logs; then
          echo "âš ï¸ Possible hardcoded credentials found!"
          exit 1
        else
          echo "âœ… No hardcoded credentials detected"
        fi

  accessibility-lighthouse:
    name: Lighthouse Accessibility
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Lighthouse CI
      run: npm install -g @lhci/cli@0.12.x

    - name: Run Lighthouse CI
      run: |
        echo "âš ï¸ Lighthouse CI requires a running server"
        echo "This is a placeholder for future implementation"
        # lhci autorun --collect.url=http://localhost:8000

  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [php-lint, phpstan, php-cs-fixer, security-check]
    if: always()

    steps:
    - name: Check results
      run: |
        echo "ğŸ“Š Code Quality Summary:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "PHP Lint: ${{ needs.php-lint.result }}"
        echo "PHPStan: ${{ needs.phpstan.result }}"
        echo "PHP CS Fixer: ${{ needs.php-cs-fixer.result }}"
        echo "Security Check: ${{ needs.security-check.result }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        if [[ "${{ needs.php-lint.result }}" == "failure" ]] || \
           [[ "${{ needs.phpstan.result }}" == "failure" ]] || \
           [[ "${{ needs.php-cs-fixer.result }}" == "failure" ]] || \
           [[ "${{ needs.security-check.result }}" == "failure" ]]; then
          echo "âŒ Some quality checks failed"
          exit 1
        else
          echo "âœ… All quality checks passed"
        fi
